from onnds import Ds
import sys
import warnings
import argparse
import os


CURRENT_DIR = os.path.dirname(os.path.realpath(__file__))

if not sys.warnoptions:
    warnings.simplefilter('ignore')

APP_NAME = 'cim'


def cim(output_filename, output_format, **kwargs):
    ds = Ds(app_name=APP_NAME, **kwargs)
    output_file_path = f'{CURRENT_DIR}/outputs/{output_filename}'

    ips_rules = ds.get_ips_rules()
    cve_ips_map = ds.get_cve_ips_map(ips_rules)
    output = ds.output_cve_ips_map(cve_ips_map, output_format)
    ds.generate_output(output, output_file_path, output_format)


def main():
    parser = argparse.ArgumentParser(description='Deep Security CVE to IPS rule mapper')
    parser.add_argument('--output-format', default='CSV', help='Output format - "CSV" or "JSON" (default: CSV)')
    parser.add_argument('--output-filename', default='map.csv', help='Output filename (default: map.csv)')
    args = parser.parse_args()
    output_filename = args.output_filename
    output_format = args.output_format

    cim(output_filename, output_format, console_logger=True)


if __name__ == '__main__':
    main()
